name: Cargo Publish

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.4.2)'
        required: true
        type: string

concurrency:
  group: cargo-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Prepare: validate tag and extract version
  # ---------------------------------------------------------------------------
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Determine Tag
        id: tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Extract version and validate
        id: version
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          # Extract version from root Cargo.toml
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          TAG_VERSION=${TAG#v}

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

          if [ "$TAG_VERSION" != "$VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match Cargo.toml version ($VERSION)"
            exit 1
          fi

  # ===========================================================================
  # Test Matrix: Run unit tests for each supported platform
  # ===========================================================================

  test:
    name: Test ${{ matrix.target }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-14
          - target: aarch64-apple-darwin
            os: macos-14
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm
          - target: aarch64-unknown-linux-musl
            os: ubuntu-24.04-arm
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 tar
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
            sudo apt-get install -y musl-tools
          fi

      - name: Run tests
        env:
          RUST_BACKTRACE: 1
        run: |
          # Use --test-threads=1 to avoid SIGSEGV from parallel access to JSC global state.
          cargo test --lib --target ${{ matrix.target }} -- --test-threads=1

  # ===========================================================================
  # Publish all crates
  # ===========================================================================

  publish:
    name: Publish Crates
    needs: [prepare, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish rust_jsc_sys
        working-directory: sys
        run: |
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published"

      - name: Publish rust_jsc_macros
        working-directory: macros
        run: |
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published"

      - name: Publish rust_jsc (root)
        run: |
          # Wait for crates.io to index macros and sys
          sleep 20
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published"
