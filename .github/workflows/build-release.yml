name: Build and Release JSC Static Libraries

on:
  push:
    branches: [main]
    paths:
      - 'sys/**'
      - 'WebKit/**'
      - '.gitmodules'
      - 'Dockerfile'
      - 'Dockerfile.arm'
      - 'Dockerfile.musl'
  workflow_dispatch:
    inputs:
      skip_cache:
        description: "Skip Docker layer cache"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: javascriptcore

jobs:
  # ---------------------------------------------------------------------------
  # Prepare: extract version from sys/Cargo.toml
  # ---------------------------------------------------------------------------
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from sys/Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' sys/Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected sys version: $VERSION"

  # ===========================================================================
  # macOS Builds (native on Apple Silicon, cross-compile x86_64)
  # ===========================================================================

  build-macos-x86_64:
    name: macOS x86_64
    runs-on: macos-14
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install universal build tools
        run: |
          # Download CMake universal binary â€” MUST be universal so it runs as x86_64
          # under Rosetta and correctly detects the host architecture.
          # Homebrew cmake is ARM64-only and would detect ARM64 even under arch -x86_64.
          CMAKE_VERSION="3.28.3"
          curl -L "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-macos-universal.tar.gz" -o cmake.tar.gz
          tar xzf cmake.tar.gz
          echo "$PWD/cmake-${CMAKE_VERSION}-macos-universal/CMake.app/Contents/bin" >> $GITHUB_PATH

          # Ninja: brew version is fine (ARM64-only but doesn't affect architecture detection;
          # cmake is what determines target arch, ninja just runs the commands cmake configured)
          brew install ninja

      - name: Build JavaScriptCore (x86_64 via Rosetta 2)
        run: |
          # Run entire build under Rosetta 2 so cmake detects x86_64 as host architecture.
          # Universal cmake/ninja binaries pick x86_64 slice, Apple Clang is always universal.
          arch -x86_64 bash -c '
            WebKit/Tools/Scripts/build-jsc --jsc-only --cmakeargs="-DENABLE_STATIC_JSC=ON -DENABLE_REMOTE_INSPECTOR=ON -DENABLE_EXPERIMENTAL_FEATURES=OFF -DUSE_THIN_ARCHIVES=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS='"'"'-Wno-unused-variable -Wno-error=unused-variable -Wno-error=constant-conversion'"'"'"
          '

      - name: Archive static libraries
        run: make archive platform=x86_64-apple-darwin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjsc-x86_64-apple-darwin
          path: libjsc-x86_64-apple-darwin.a.gz
          retention-days: 7

  build-macos-aarch64:
    name: macOS aarch64
    runs-on: macos-14
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: brew install cmake ninja

      - name: Build JavaScriptCore
        run: make build-jsc

      - name: Archive static libraries
        run: make archive platform=aarch64-apple-darwin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjsc-aarch64-apple-darwin
          path: libjsc-aarch64-apple-darwin.a.gz
          retention-days: 7

  # ===========================================================================
  # Linux x86_64 Builds (Docker on x86_64 runners)
  # ===========================================================================

  build-linux-x86_64:
    name: Linux x86_64 (glibc)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune --all --force
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-linux-x86_64
          key: buildx-linux-x86_64-${{ hashFiles('Dockerfile') }}
          restore-keys: buildx-linux-x86_64-

      - name: Build JavaScriptCore
        run: |
          mkdir -p .libs
          docker buildx build \
            --output type=local,dest=./.libs \
            --cache-from type=local,src=/tmp/.buildx-cache-linux-x86_64 \
            --cache-to type=local,dest=/tmp/.buildx-cache-linux-x86_64-new,mode=max \
            -f Dockerfile .

      - name: Rotate cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache-linux-x86_64
          mv /tmp/.buildx-cache-linux-x86_64-new /tmp/.buildx-cache-linux-x86_64 2>/dev/null || true

      - name: Archive static libraries
        run: |
          cd .libs
          tar -czf libjsc-x86_64-unknown-linux-gnu.a.gz *.a
          mv libjsc-x86_64-unknown-linux-gnu.a.gz ../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjsc-x86_64-unknown-linux-gnu
          path: libjsc-x86_64-unknown-linux-gnu.a.gz
          retention-days: 7

  build-linux-x86_64-musl:
    name: Linux x86_64 (musl)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune --all --force
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-linux-musl-x86_64
          key: buildx-linux-musl-x86_64-${{ hashFiles('Dockerfile.musl') }}
          restore-keys: buildx-linux-musl-x86_64-

      - name: Build JavaScriptCore
        run: |
          mkdir -p .libs-musl
          docker buildx build \
            --output type=local,dest=./.libs-musl \
            --cache-from type=local,src=/tmp/.buildx-cache-linux-musl-x86_64 \
            --cache-to type=local,dest=/tmp/.buildx-cache-linux-musl-x86_64-new,mode=max \
            -f Dockerfile.musl .

      - name: Rotate cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache-linux-musl-x86_64
          mv /tmp/.buildx-cache-linux-musl-x86_64-new /tmp/.buildx-cache-linux-musl-x86_64 2>/dev/null || true

      - name: Archive static libraries
        run: |
          cd .libs-musl
          tar -czf libjsc-x86_64-unknown-linux-musl.a.gz *.a
          mv libjsc-x86_64-unknown-linux-musl.a.gz ../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjsc-x86_64-unknown-linux-musl
          path: libjsc-x86_64-unknown-linux-musl.a.gz
          retention-days: 7

  # ===========================================================================
  # Linux aarch64 Builds (Docker on native ARM64 runners â€” no QEMU)
  # ===========================================================================

  build-linux-aarch64:
    name: Linux aarch64 (glibc)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune --all --force
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-linux-aarch64
          key: buildx-linux-aarch64-${{ hashFiles('Dockerfile') }}
          restore-keys: buildx-linux-aarch64-

      # Native ARM64 runner: use the standard Dockerfile (same as x86_64 glibc)
      - name: Build JavaScriptCore
        run: |
          mkdir -p .libs-arm
          docker buildx build \
            --output type=local,dest=./.libs-arm \
            --cache-from type=local,src=/tmp/.buildx-cache-linux-aarch64 \
            --cache-to type=local,dest=/tmp/.buildx-cache-linux-aarch64-new,mode=max \
            -f Dockerfile .

      - name: Rotate cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache-linux-aarch64
          mv /tmp/.buildx-cache-linux-aarch64-new /tmp/.buildx-cache-linux-aarch64 2>/dev/null || true

      - name: Archive static libraries
        run: |
          cd .libs-arm
          tar -czf libjsc-aarch64-unknown-linux-gnu.a.gz *.a
          mv libjsc-aarch64-unknown-linux-gnu.a.gz ../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjsc-aarch64-unknown-linux-gnu
          path: libjsc-aarch64-unknown-linux-gnu.a.gz
          retention-days: 7

  build-linux-aarch64-musl:
    name: Linux aarch64 (musl)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune --all --force
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-linux-musl-aarch64
          key: buildx-linux-musl-aarch64-${{ hashFiles('Dockerfile.musl') }}
          restore-keys: buildx-linux-musl-aarch64-

      # Native ARM64 runner: use Dockerfile.musl directly (no QEMU)
      - name: Build JavaScriptCore
        run: |
          mkdir -p .libs-arm-musl
          docker buildx build \
            --output type=local,dest=./.libs-arm-musl \
            --cache-from type=local,src=/tmp/.buildx-cache-linux-musl-aarch64 \
            --cache-to type=local,dest=/tmp/.buildx-cache-linux-musl-aarch64-new,mode=max \
            -f Dockerfile.musl .

      - name: Rotate cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache-linux-musl-aarch64
          mv /tmp/.buildx-cache-linux-musl-aarch64-new /tmp/.buildx-cache-linux-musl-aarch64 2>/dev/null || true

      - name: Archive static libraries
        run: |
          cd .libs-arm-musl
          tar -czf libjsc-aarch64-unknown-linux-musl.a.gz *.a
          mv libjsc-aarch64-unknown-linux-musl.a.gz ../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjsc-aarch64-unknown-linux-musl
          path: libjsc-aarch64-unknown-linux-musl.a.gz
          retention-days: 7

  # ===========================================================================
  # Tests
  # ===========================================================================

  test:
    name: Tests
    runs-on: macos-14
    needs: [build-macos-aarch64]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS aarch64 artifact
        uses: actions/download-artifact@v4
        with:
          name: libjsc-aarch64-apple-darwin
          path: .

      - name: Extract static libraries
        run: |
          mkdir -p .jsc-libs
          tar -xzf libjsc-aarch64-apple-darwin.a.gz -C .jsc-libs
          ls -la .jsc-libs/

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: rust-test-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: rust-test-${{ runner.os }}-

      - name: Run tests
        env:
          RUST_JSC_CUSTOM_BUILD_PATH: ${{ github.workspace }}/.jsc-libs
          RUST_BACKTRACE: 1
        run: cargo test --lib -- --test-threads=1

  # ===========================================================================
  # Release
  # ===========================================================================

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-macos-x86_64
      - build-macos-aarch64
      - build-linux-x86_64
      - build-linux-aarch64
      - build-linux-x86_64-musl
      - build-linux-aarch64-musl
      - test
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts -name '*.a.gz' -exec cp {} release-files/ \;
          echo "ðŸ“¦ Release files:"
          ls -lh release-files/

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="sys-v${{ needs.prepare.outputs.version }}"

          echo "Release tag: $TAG"

          # Create new release with all platform archives
          # Fails if the tag already exists, forcing a version bump
          gh release create "$TAG" \
            --title "Rust-JSC-Sys $TAG" \
            --generate-notes \
            release-files/*.a.gz

          echo "Release $TAG created successfully"
